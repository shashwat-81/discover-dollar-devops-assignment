name: CI/CD - Build, Push, Deploy

on:
  push:
    branches:
      - main
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build & push BACKEND image
      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:${{ github.sha }}

      # Build & push FRONTEND image
      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:${{ github.sha }}

      # Deploy to EC2 via SSH
      - name: Deploy on EC2
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

          ssh -o StrictHostKeyChecking=no -i key.pem ${SSH_USER}@${SSH_HOST} << 'EOF'
          set -e

          cd ~/discover-dollar-devops-assignment

          # Pull latest code
          git pull

          # Pull latest images from Docker Hub
          sudo docker compose pull

          # Restart containers with new images
          sudo docker compose up -d

          # Show running containers
          sudo docker compose ps
          EOF
